<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>網格變形圖像動畫編輯軟體</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div id="app">
    <div class="editor-container">
      <!-- 頂部標題列 -->
      <div class="header">
        <div class="menu-bar">
          <div class="menu-item" @click.stop="toggleDropdown('fileDropdown')"> <!-- 添加.stop修飾符 -->
            檔案
            <div class="dropdown-menu" v-show="fileDropdown">
              <div class="dropdown-item" @click="handleFileAction('new')">新增</div>
              <div class="dropdown-item" @click="handleFileAction('open')">開啟</div>
              <div class="dropdown-item" @click="handleFileAction('save')">儲存</div>
              <div class="dropdown-item" @click="handleFileAction('export')">匯出</div>
            </div>
          </div>
          <div class="menu-item" @click="toggleDropdown('editDropdown')">
            編輯
            <div class="dropdown-menu" v-show="editDropdown">
              <div class="dropdown-item" @click="handleEditAction('undo')">復原</div>
              <div class="dropdown-item" @click="handleEditAction('redo')">重做</div>
              <div class="dropdown-item" @click="handleEditAction('cut')">剪下</div>
              <div class="dropdown-item" @click="handleEditAction('copy')">複製</div>
              <div class="dropdown-item" @click="handleEditAction('paste')">貼上</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 主畫面：左側工具列 / 中間畫布區 / 右側圖層面板 -->
      <div class="main-container">
        <!-- 左側工具 -->
        <div class="toolbar">
          <button class="tool-btn" :class="{ active: activeTool === 'grab-point' }" @click="selectTool('grab-point')"  @contextmenu.prevent>grab-point</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-create' }" @click="selectTool('bone-create')"  @contextmenu.prevent>bone-create</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-animate' }" @click="selectTool('bone-animate')"  @contextmenu.prevent>bone-animate</button>
        </div>

        <!-- 中間畫布 -->
        <div class="canvas-area"  @contextmenu.prevent>
          <div class="image-container" ref="imageContainer" @contextmenu.prevent>
            
            <canvas class="image-canvas"  id="webgl" width="640" height="480" @contextmenu.prevent></canvas>
            <!--
            <br>
            <button @click="downloadImage" class="download-btn">Download Deformed Image</button>
            <img class="image-canvas" id="main-image" :src="imageData" alt="讀取圖片" @mousedown="handleCanvasMouseDown"
              @mousemove="handleCanvasMouseMove" @mouseup="handleCanvasMouseUp" @contextmenu.prevent>-->

            <!-- 此覆蓋層用於呈現點擊新增的圓圈
            <div class="overlay-canvas">
              <div v-for="(point, index) in points" :key="index" class="point" :style="{
                  position: 'absolute',
                  width: '10px',
                  height: '10px',
                  borderRadius: '50%',
                  backgroundColor: 'red',
                  left: point.x + 'px',
                  top: point.y + 'px'
                }"></div>
            </div> -->
          </div>
          <!-- 清除所有點的按鈕 -->
          <button @click="clearPoints" style="position:absolute; top:10px; right:10px; z-index:100;">清除點</button>
        </div>



          <!-- 右側圖層 -->
          <div class="layers-panel">
            <div class="panel-section layers-section" style="height: 200px; flex: 0 0 200px;">
              <div class="panel-title">階層式物件</div>
              <div class="layers-container">
                <div class="tree-item">
                  <div class="tree-item-header">
                    <span class="tree-toggle-icon" :class="{ 'expanded': expandedNodes.includes('root') }"
                      @click.stop="toggleNode('root')">▶</span>
                    <span class="tree-item-name" @click.stop="handleNameClick('Root')">Root</span>
                  </div>
                  <div class="tree-children" v-if="expandedNodes.includes('root')">
                    <div class="tree-item">
                      <div class="tree-item-header">
                        <span class="tree-toggle-icon" :class="{ 'expanded': expandedNodes.includes('child1') }"
                          @click.stop="toggleNode('child1')">▶</span>
                        <span class="tree-item-name" @click.stop="handleNameClick('Child1')">Child1</span>
                      </div>
                      <div class="tree-children" v-if="expandedNodes.includes('child1')">
                        <div class="tree-item">
                          <div class="tree-item-header">
                            <span class="tree-item-name" @click.stop="handleNameClick('GrandChild')">GrandChild</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="tree-item">
                      <div class="tree-item-header">
                        <span class="tree-item-name" @click.stop="handleNameClick('Child2')">Child2</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <div class="panel-section layers-section" style="height: 400px; flex: 0 0 400px;">
              <div class="panel-title">圖層</div>
              <div class="layers-content">
                <div class="layers-container">
                  <div v-for="layer in layers" :key="layer.id" class="layer-item"
                    :class="{ active: layer.id === selectedLayerId }" @click="selectLayer(layer.id)">
                    {{ layer.name }}
                  </div>
                </div>
                <div class="layers-actions">
                  <button class="layer-btn" @click="addLayer">新增圖層</button>
                  <button class="layer-btn" @click="deleteLayer">刪除選中圖層</button>
                  <button class="layer-btn" @click="saveLayerToServer">儲存圖層到伺服器</button>
                </div>
              </div>
            </div>
          </div>




        </div>

        <!-- 動畫時間軸 -->
        <div class="timeline">
          <div class="timeline-header">
            <div class="timeline-title">動畫時間軸</div>
            <div class="timeline-controls">
              <button class="timeline-btn" @click="addKeyframe">新增Key點</button>
              <button class="timeline-btn" @click="addTimelineComponent">新增時間軸元件</button>
            </div>
          </div>
          <div class="timeline-content">
            <div class="timeline-layers">
              <div v-for="layer in layers" :key="'timeline-' + layer.id" class="timeline-layer-item">
                {{ layer.name }}
              </div>
            </div>
            <div class="timeline-tracks" ref="timelineTracks" @mousedown="startDrag" @mousemove="onDrag"
              @mouseup="stopDrag" @mouseleave="stopDrag">
              <div v-for="keyframe in keyframes" :key="keyframe.id" class="keyframe"
                :style="{ left: keyframe.position + 'px' }" :title="'Keyframe ' + keyframe.id"
                @click.stop="selectKeyframe(keyframe.id)"></div>
            </div>
          </div>
        </div>

        <!-- 狀態列 -->
        <div class="status-bar">
          <div class="status-item">狀態: {{ status }}</div>
        </div>
      </div>
    </div>

    <script type="module">
      // 創建應用
      import app from './app.js';
      app.mount('#app');
    </script>
</body>

</html>