<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>網格變形圖像動畫編輯軟體</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <script src="app.js" type="module"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div id="app">
    <div class="editor-container">
      <!-- 頂部標題列 -->
      <div class="header">
        <div class="menu-bar">
          <div class="menu-item" @click.stop="toggleDropdown('fileDropdown')"> <!-- 添加.stop修飾符 -->
            檔案
            <div class="dropdown-menu" v-show="fileDropdown">
              <div class="dropdown-item" @click="handleFileAction('new')">新增</div>
              <div class="dropdown-item" @click="handleFileAction('open')">開啟</div>
              <div class="dropdown-item" @click="handleFileAction('save')">儲存</div>
              <div class="dropdown-item" @click="handleFileAction('export')">匯出</div>
            </div>
          </div>
          <div class="menu-item" @click="toggleDropdown('editDropdown')">
            編輯
            <div class="dropdown-menu" v-show="editDropdown">
              <div class="dropdown-item" @click="handleEditAction('undo')">復原</div>
              <div class="dropdown-item" @click="handleEditAction('redo')">重做</div>
              <div class="dropdown-item" @click="handleEditAction('cut')">剪下</div>
              <div class="dropdown-item" @click="handleEditAction('copy')">複製</div>
              <div class="dropdown-item" @click="handleEditAction('paste')">貼上</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 主畫面：左側工具列 / 中間畫布區 / 右側圖層面板 -->
      <div class="main-container">
        <!-- 左側工具 -->
        <div class="toolbar">
          <button class="tool-btn" :class="{ active: activeTool === 'grab-point' }" @click="selectTool('grab-point')"
            @contextmenu.prevent>grab-point</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-create' }" @click="selectTool('bone-create')"
            @contextmenu.prevent>bone-create</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-animate' }"
            @click="selectTool('bone-animate')" @contextmenu.prevent>bone-animate</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-clear' }" @click="selectTool('bone-clear')"
            @contextmenu.prevent>bone-clear</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-save' }" @click="selectTool('bone-save')"
            @contextmenu.prevent>bone-save</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-read' }" @click="selectTool('bone-read')"
            @contextmenu.prevent>bone-read</button>
        </div>

        <!-- 中間畫布 -->
        <div class="canvas-area" @contextmenu.prevent>
          <div class="image-container" ref="imageContainer" @contextmenu.prevent>

            <canvas class="image-canvas" id="webgl" width="640" height="480" @contextmenu.prevent></canvas>

          </div>
          <!-- 清除所有點的按鈕 -->
          <button @click="clearPoints" style="position:absolute; top:10px; right:10px; z-index:100;">清除點</button>
        </div>



        <!-- 右側圖層 -->
        <div class="layers-panel">
          <div class="panel-section layers-section" style="height: 200px; flex: 0 0 200px;">
            <div class="panel-title">階層式物件</div>
            <div class="layers-container">
              <tree-item v-for="root in boneTree" :key="root.id" :node="root" :expanded-nodes="expandedNodes"
                :selected-bone="selectedBone" @toggle-node="toggleNode" @name-click="handleNameClick">
              </tree-item>
            </div>
          </div>



          <div class="panel-section layers-section" style="height: 400px; flex: 0 0 400px;">
            <div class="panel-title">圖層</div>
            <div class="layers-content">
              <div class="layers-container">



              </div>
              <div class="layers-actions">
                <button class="layer-btn" @click="addLayer">新增圖層</button>
                <button class="layer-btn" @click="deleteLayer">刪除選中圖層</button>
                <button class="layer-btn" @click="saveLayerToServer">儲存圖層到伺服器</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="timeline" class="timeline" v-on:contextmenu.prevent>
        <div class="timeline-header">
          <div class="timeline-title">動畫時間軸</div>
          <div class="timeline-controls">
            <button class="timeline-btn" v-on:click="timeline.addKeyframe">新增Key點</button>
            <button class="timeline-btn" v-on:click="addKeyframe">新增Key點2</button>
            <button class="timeline-btn" v-on:click="addTimelineComponent">新增時間軸元件</button>
            <button class="timeline-btn" v-on:click="playAnimation">播放動畫</button>
            <button class="timeline-btn" v-on:click="timeline.playAnimation">播放動畫2</button>
            <button class="timeline-btn" v-on:click="stopAnimation">停止動畫</button>
            <button class="timeline-btn" v-on:click="timeline.stopAnimation">停止動畫2</button>
            <button class="timeline-btn" v-on:click="testCountFn">{{timeline.testCount}}</button>
            <button class="timeline-btn" v-on:click="timeline.testCountFn">{{timeline.testCount}}</button>
          </div>
        </div>
        <div class="timeline-content">
          <div class="timeline-layers" id="timelineLayers">


            <div v-for="bone in flattenedBones" v-bind:key="'layer-' + bone.id" class="tree-item-content"
              v-bind:class="{ 'selected': selectedBone && selectedBone.id === bone.id }" v-on:click="selectBone(bone)">
              <span>{{ bone.id}}</span>

            </div>
          </div>


          <div class="timeline-tracks" id="timelineTracks" ref="timelineTracks" v-on:mousedown="timeline.startPlayheadDrag"
            v-on:mousemove="timeline.onPlayheadDrag" v-on:mouseup="timeline.stopPlayheadDrag" v-on:mouseleave="timeline.stopPlayheadDrag">


            <div class="timeline-scale" v-bind:style="{ width: timelineLength + 'px' }">
              <span v-for="n in Math.ceil(timelineLength / 50)" v-bind:key="n" class="scale-mark"
                v-bind:style="{ left: (n-1) * 50 + 'px' }">{{ (n-1) * 1 }}</span>

            </div>

            <div id="trackContainer" ref="trackContainer" @mousedown="timeline.startDrag($event, $refs.trackContainer)"
              @mousemove="timeline.onDrag($event, $refs.trackContainer)" @mouseup="timeline.stopDrag()"
              @mouseleave="timeline.stopDrag()" class="timeline-container">
              <div v-for="bone in flattenedBones" v-bind:key="'track-' + bone.id" class="timeline-track"
                v-bind:style="{ top: bone.trackY + 'px' }">
                <div v-for="keyframe in timeline.keyframes[bone.id]" v-bind:key="keyframe.id" class="keyframe"
                  @mousedown.stop="timeline.startDrag($event, $refs.trackContainer)"
                  v-bind:style="{ left: keyframe.position + 'px' }"
                  v-bind:class="{ 'selected': timeline.selectedKeyframe === keyframe }"
                  v-bind:title="'Keyframe ' + keyframe.id" :data-id="keyframe.id" :data-bone-id="bone.id">

                </div>
              </div>
            </div>

            <div id="timeSelection" class="time-selection"
              v-bind:style="{ display: timeSelection.active ? 'block' : 'none', left: timeSelection.start + 'px', width: (timeSelection.end - timeSelection.start) + 'px' }">
            </div>

            <div id="playhead" class="playhead" v-bind:style="{ left: timeline.playheadPosition + 'px' }"
              v-on:mousedown="startPlayheadDrag"> 
            </div>


            <div id="timeIndicator" class="current-time-indicator"
              v-bind:style="{ left: timeline.playheadPosition + 'px' }">
              {{ (timeline.playheadPosition / 50).toFixed(2) }}s
            </div>
          </div>
        </div>
      </div>


      <!-- 狀態列 -->
      <div class="status-bar">
        <div class="status-item">狀態: {{ status }}</div>
      </div>
    </div>
  </div>

  <script type="module">
    // 創建應用
    import app from './app.js';
    app.mount('#app');
  </script>
</body>

</html>