<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>網格變形圖像動畫編輯軟體</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <script src="app.js" type="module"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div id="app">
    <div class="editor-container">
      <!-- 頂部標題列 -->
      <div class="header">
        <div class="menu-bar">
          <div class="menu-item" @click.stop="toggleDropdown('fileDropdown')"> <!-- 添加.stop修飾符 -->
            檔案
            <div class="dropdown-menu" v-show="fileDropdown">
              <div class="dropdown-item" @click.stop="handleFileAction('new')">新增</div>
              <div class="dropdown-item" @click.stop="handleFileAction('open')">開啟</div>
              <div class="dropdown-item" @click.stop="handleFileAction('save')">儲存</div>
              <div class="dropdown-item" @click.stop="handleFileAction('export')">匯出</div>
            </div>
          </div>
          <div class="menu-item" @click.stop="toggleDropdown('editDropdown')">
            編輯
            <div class="dropdown-menu" v-show="editDropdown">
              <div class="dropdown-item" @click.stop="handleEditAction('undo')">復原</div>
              <div class="dropdown-item" @click.stop="handleEditAction('redo')">重做</div>
              <div class="dropdown-item" @click.stop="handleEditAction('cut')">剪下</div>
              <div class="dropdown-item" @click.stop="handleEditAction('copy')">複製</div>
              <div class="dropdown-item" @click.stop="handleEditAction('paste')">貼上</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 主畫面：左側工具列 / 中間畫布區 / 右側圖層面板 -->
      <div class="main-container">
        <!-- 左側工具 -->
        <div class="toolbar">
          <button class="tool-btn" :class="{ active: activeTool === 'grab-point' }" @click="selectTool('grab-point')"
            @contextmenu.prevent>grab-point</button>
          <button class="tool-btn" :class="{ active: activeTool === 'select-points' }"
            @click="selectTool('select-points')" @contextmenu.prevent>select-points</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-create' }" @click="selectTool('bone-create')"
            @contextmenu.prevent>bone-create</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-animate' }"
            @click="selectTool('bone-animate')" @contextmenu.prevent>bone-animate</button>
            <button class="tool-btn" :class="{ active: activeTool === 'bind-bones' }"
            @click="bindingBoneWeight(1.0)" @contextmenu.prevent>auto bind bones</button>
         
          <button class="tool-btn" :class="{ active: activeTool === 'bone-save' }" @click="selectTool('bone-save')"
            @contextmenu.prevent>bone-save</button>
          <button class="tool-btn" :class="{ active: activeTool === 'bone-load' }" @click="selectTool('bone-load')"
            @contextmenu.prevent>bone-load</button>
          <button class="tool-btn" :class="{ active: activeTool === 'reset-pose' }" @click="resetPose()"
            @contextmenu.prevent>reset pose</button>
        </div>

        <!-- 中間畫布 -->
        <div class="canvas-area" @contextmenu.prevent>
          <div class="image-container" ref="imageContainer" @contextmenu.prevent>

            <canvas class="image-canvas" id="webgl" width="640" height="480" @contextmenu.prevent></canvas>

          </div>
        </div>



        <!-- 右側圖層 -->
        <div class="layers-panel">
          <div class="panel-section layers-section" style="height: 200px; flex: 0 0 200px;">
            <div class="panel-title">階層式物件</div>
            <div class="layers-container">
              <div v-for="skeleton in skeletons" :key="skeleton.name" class="skeleton-block">
                <div class="skeleton-header">{{ skeleton.name }}</div>

                <tree-item v-for="root in skeleton.rootBones" :key="root.id" :node="root"
                  :expanded-nodes="expandedNodes" :selected-bone="selectedBone" @toggle-node="toggleNode"
                  @name-click="handleNameClick" />
              </div>
            </div>
          </div>

          <div class="panel-section layers-section" style="height:200px; flex: 0 0 200px;">
            <div class="panel-title">圖層</div>
            <div class="layers-content">
              <div class="layers-container">
                <div id="layerContainer"></div>
                <span>{{ showLayers?.length }}</span>

                <div v-for="(layer, index) in showLayers" :key="index" class="layer-item">
                  <!-- 勾選控制顯示/隱藏 -->
                  <input type="checkbox" :value="index" v-model="selectedLayers" />

                  <!-- 點擊名稱選擇圖層 -->
                  <span class="layer-name" :class="{ active: chosenLayers.includes(index) }"
                    @click="toggleLayerSelection(index)">
                    圖層 {{ layer.name }}
                  </span>
                </div>


              </div>
            </div>
          </div>


          <div class="panel-section layers-section" style="height: 200px; flex: 0 0 200px;">
            <div class="panel-title">屬性</div>
            <div class="layers-content">
              <div class="layers-container">
                <span> select bone: {{ lastSelectedBone?.name }}</span><br>
                <span> chose layer: {{ currentChosedLayer }}</span><br>

                <!-- Multi-select for vertex groups -->
                <label for="vertex-group-select">Vertex Groups:</label>
                <div class="vertex-group-list">
                  <div v-for="group in vertexGroupInfo" :key="group.name" class="vertex-group-item"
                    :class="{ selected: selectedGroups.includes(group.name) }" @click="toggleSelect(group.name)"
                    @dblclick="startEdit(group.name)">

                    <!-- 如果正在編輯這個 group，就顯示 input -->
                    <input v-if="editingGroup === group.name" v-model="editName" @keyup.enter="confirmEdit(group)"
                      @blur="confirmEdit(group)" autofocus />

                    <!-- 否則顯示文字 -->
                    <span v-else>
                      {{ group.name }} 
                    </span>
                  </div>
                </div>

                <!-- 四個按鈕：橫向排列 -->
                <div class="vertex-btn-group">
                  <button @click="onAdd">+</button>
                  <button @click="onRemove">-</button>
                </div>
                <div class="vertex-btn-group">
                  <button @click="onAssign">Assign</button>
                  <button @click="onSelect">Select</button>
                </div>
                <div class="vertex-btn-group">
                  <span> set weight</span>
                  <input type="number" v-model.number="weightValue" step="0.1" min="0" max="1" />
                  <button @click="setWeight">Set</button>
                </div>
              </div>
            </div>
          </div>




        </div>
      </div>

      <div v-if="timeline" class="timeline" v-on:contextmenu.prevent>
        <div class="timeline-header">
          <div class="timeline-title">動畫時間軸</div>
          <div class="timeline-controls">
            <button class="timeline-btn" v-on:click="timeline.addKeyframe">新增Key點</button>
            <button class="timeline-btn" v-on:click="timeline.deleteSelectedKeyframe">刪除Key點</button>
            <input type="file" accept=".psd" id="psdFile" @change="handlePSDUpload">
            <button class="timeline-btn" v-on:click="firstImage">image</button>
            <button class="timeline-btn" v-on:click="secondImage">image2</button>
            <button class="timeline-btn" v-on:click="psdImage">usePsd</button>
            <button class="timeline-btn" v-on:click="drawAgain">drawAgain</button>
            <button class="timeline-btn" v-on:click="timeline.playAnimation">播放動畫</button>
            <button class="timeline-btn" v-on:click="testCountFn">{{timeline.testCount}}</button>
            <button class="timeline-btn" v-on:click="timeline.testCountFn">{{timeline.testCount}}</button>
            <button class="timeline-btn" v-on:click="showBone">show bone</button>
          </div>
        </div>
        <div class="timeline-content">
          <div class="timeline-layers" id="timelineLayers">
            <div v-for="bone in flattenedBones" v-bind:key="'layer-' + bone.id" class="tree-item-content"
              v-bind:class="{ 'selected': selectedBone && selectedBone.index === bone.index }"
              v-on:click="selectBone(bone)">
              <span>{{ bone.id}}</span>
            </div>
          </div>
          <div class="timeline-tracks" id="timelineTracks" ref="timelineTracks"
            @mousedown="timeline.startDrag($event, $refs.timelineTracks)"
            @mousemove="timeline.onDrag($event, $refs.timelineTracks)" @mouseup="timeline.stopDrag()">
            <div class="timeline-scale" :style="{ width: timelineLength + 'px' }">
              <span v-for="n in Math.ceil(timelineLength / 50)" :key="n" class="scale-mark"
                :style="{ left: (n-1) * 50 + 'px' }">{{ (n-1) * 1 }}</span>
            </div>
            <div id="trackContainer" ref="trackContainer" @mousedown="timeline.startDrag($event, $refs.trackContainer)"
              @mousemove="timeline.onDrag($event, $refs.trackContainer)" @mouseup="timeline.stopDrag()"
              class="timeline-container">
              <div v-for="bone in flattenedBones" :key="'track-' + bone.id" class="timeline-track"
                :style="{ top: bone.trackY + 'px' }">
                <div v-for="keyframe in timeline.keyframes[bone.id]" :key="keyframe.id" class="keyframe"
                  @mousedown.stop="timeline.startDrag($event, $refs.trackContainer)"
                  :style="{ left: keyframe.position + 'px' }"
                  :class="{ 'selected': timeline.selectedKeyframe && timeline.selectedKeyframe.id === keyframe.id && timeline.selectedKeyframe.boneId === bone.id, 'dragging': timeline.isDragging && timeline.selectedKeyframe && timeline.selectedKeyframe.id === keyframe.id }"
                  :title="'Keyframe ' + keyframe.id" :data-id="keyframe.id" :data-bone-id="bone.id">
                </div>
              </div>
            </div>
            <div id="timeSelection" class="time-selection"
              :style="{ display: timeline.timeSelection.active ? 'block' : 'none', left: timeline.timeSelection.start + 'px', width: (timeline.timeSelection.end - timeline.timeSelection.start) + 'px' }">
            </div>
            <div id="playhead" class="playhead" :style="{ left: timeline.playheadPosition + 'px' }"
              @mousedown="timeline.startDrag($event, $refs.timelineTracks)">
            </div>
            <div id="timeIndicator" class="current-time-indicator" :style="{ left: timeline.playheadPosition + 'px' }">
              {{ (timeline.playheadPosition / 50).toFixed(2) }}s
            </div>
          </div>



        </div>
      </div>


      <!-- 狀態列 -->
      <div class="status-bar">
        <div class="status-item">狀態: {{ status }}</div>
      </div>
    </div>
  </div>

  <script type="module">
    // 創建應用
    import app from './app.js';
    app.mount('#app');
  </script>
</body>

</html>